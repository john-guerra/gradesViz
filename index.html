<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Grades Viz</title>
  <style>
    body {
      font-family: sans-serif;
    }
    circle {
      fill: steelblue;
      opacity: 0.7;
    }
    .axis--x {
      font-size: 12pt;
    }
    .axis--x text {
      fill: black;
    }
    .axis--x .axis_legend {
      font-size: 14pt;
      text-anchor: start;
    }
    .tooltip {
      text-anchor: middle;
    }
    .tick {
      stroke-dasharray: 1,7;
    }
    p {
      font-size: 14pt;
    }

    .mean {
      stroke: darkblue;
      stroke-width: 1.5;
      stroke-dasharray: 5,7;
    }
    .subGraph rect {
      fill:#eee;
      stroke-width: 1;
      stroke: rgb(197, 197, 197);
    }

  </style>
  <script src="https://d3js.org/d3.v4.js"></script>
</head>
<body>
  <h1>Notas parcial</h1>
  <h2>Visual Analytics</h2>
  <button id="btnShuffle">shuffle</button>
  <div id="chart"></div>
  <br>
  <p>Mira como te fue, entra tu código <input type="text" id="inputCode"> <button id="btnSearch">Buscar</button></p>
  <p id="res"></p>

  <script>

  var width = window.innerWidth
    || document.documentElement.clientWidth
    || document.body.clientWidth;
  width -= 100;

  var height = 900;



  // height = height - 150;

  var svg = d3.select("#chart")
    .append("svg")
    .attr("width", width)
    .attr("height", height),
    margin = {top: 20, right: 60, bottom: 60, left: 20},
    width = width- margin.left - margin.right,
    height = height - margin.top - margin.bottom;


  var g = svg.append("g")
    .attr("class", "points")
    .attr("transform", "translate(" +  margin.left + " ," + margin.top + ")");

  var subGraphsG = g.append("g")
    .attr("class", "subGraphs");



  // g.append("g")
  //   .attr("class", "axis--y")
  //   .attr("transform", "translate(" + width + ",0)")
  //     .append("text")
  //     .attr("class", "axis_legend")
  //     .text("Porcentage")
  //     .attr("transform", "translate(0, 0) rotate(-90)");



  var x = d3.scaleLinear().range([0, width]);
  var ySubGraphs = d3.scaleLinear().range([0, height]);


  var stack = d3.stack();

  function drawGradesChart(sel, data, gradeFn, graphHeight) {
    var mean = 0;
    data.forEach(function (d, i) {
      mean += gradeFn(d, i) / data.length;
    });

    var yRange = [10, graphHeight-10];

    var y = function (d) {
      return yRange[0] + Math.random()*(yRange[1]-yRange[0]);
    };
    updateGradesChart(data);

    .append("g")
    .attr("class", "axis--x")
    .attr("transform", "translate(0," + height + ")")
      .append("text")
      .attr("class", "axis_legend")
      .text("Nota")
      .attr("transform", "translate(0, " + (margin.bottom - 20 ) + ") ");


      // UPDATE
    function updateGradesChart(data) {

      var meanSel = sel
        .selectAll(".mean")
        .data([mean]);

      var meanEnter = meanSel.enter()
        .append("line")
        .attr("class", "mean");

      meanSel.merge(meanEnter)
        .attr("x1", function (d) { return x(d);})
        .attr("x2", function (d) { return x(d);})
        .attr("y1", yRange[0])
        .attr("y2", yRange[1]);

      meanSel.exit().remove();

      var points = sel.selectAll("circle")
       .data(data, function (d) { return d.code; });

      var pointsEnter = points.enter()
        .append("circle")
        .attr("cx", 0)
        .attr("r", 5);

      points.merge(pointsEnter)
        .attr("id", function (d) { return "circle" + d.code; })
        .transition()
        .duration(1000)
        .attr("cx", function (d,i) { return x(gradeFn(d, i)); })
        .attr("cy", function (d,i) { return y(gradeFn(d, i)); });

      points.exit()
        .remove();


      //mean
    }
  }



  function ready(err, data, pcts) {
    if (err) throw err;

    // Preprocessing
    d3.keys(pcts[0]).forEach(function (point) {
      pcts[0][point] = +pcts[0][point];
    });
    data.forEach(function (student) {
      d3.keys(pcts[0]).forEach(
        function (point) {
          student[point] = +student[point];
        }
      )
    });

    stack.keys(d3.keys(pcts[0]));

    //compute the domain of the subgraphs, usually 100%
    ySubGraphs.domain([0, d3.sum(d3.values(pcts[0]))]);

    x.domain([0, 10]);

    //Draw Axis
    d3.select(".axis--x")
      .call(d3.axisBottom(x)
        .tickSizeInner(-height)
        // .tickSizeOuter(10)
        .tickPadding(15)
      );


    //Draw subgraphs
    var subGraphs = subGraphsG.selectAll(".subGraph")
      .data(stack(pcts));

    var subGraphHeight = function (d) {
        return ySubGraphs(d[0][1])-ySubGraphs(d[0][0]); };
    var subGraphsEnter = subGraphs.enter()
      .append("g")
      .attr("class", "subGraph")
      .attr("transform", function (d) {
        return "translate(" + 0 + "," + ySubGraphs(d[0][0]) + ")";
      });

    subGraphsEnter
      .append("rect")
      .attr("x", 0)
      .attr("y", 0)
      .attr("width", width)
      .attr("height", subGraphHeight )

    subGraphsEnter
      .each(function (point) {
        drawGradesChart(d3.select(this), data,
          function (d) { return d[point.key]; },
          subGraphHeight(point));
      });


    // d3.select(".axis--y")
    //   .call(d3.axisRight(ySubGraphs)
    //     // .tickSizeInner(-height)
    //     // .tickSizeOuter(10)
    //     .tickPadding(15)
    //   );



    d3.select("#btnSearch")
      .on("click", onSearch);

    d3.select("#inputCode")
      .on("change", onSearch);

    d3.select("#btnShuffle")
      .on("click", function () { update(data); })




    function selectGrades(d) {
      d3.selectAll("circle")
        .transition()
        .duration(500)
        .attr("r", 5)
        .style("opacity", 0.7)
        .style("fill", "steelblue");
      d3.selectAll(".tooltip").remove();


      d3.selectAll("#circle"+d.code)
        .transition()
        .duration(2000)
        .attr("r", 10)
        .style("opacity", 1.0)
        .style("fill", "darkred");

      //tooltip
      var text = "Nota: " + d.grade +  " código: " + d.code + "\n";
      g
        .append("text")
        .attr("class", "tooltip")
        .attr("x",  x(d.grade))
        .attr("y",  0)
        .text(text);

      d3.select("#res")
        .text(text);
    }

    function onSearch(evt) {
      var code = d3.select("#inputCode").property("value").trim();

      var res =data.filter(function (d) { return d.code===code; });

      if (res.length<1) {
        alert("Código no encontrado, intenta de nuevo!");
        return;
      }

      selectGrades(res[0]);
    }




  };


  var queue = d3.queue()
    .defer(d3.csv, "grades.csv")
    .defer(d3.csv, "pcts.csv")
    .await(ready);


  </script>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-72531610-1', 'auto');
  ga('send', 'pageview');

  </script>
</body>
</html>